// Description: This query is designed to detect potentially unauthorized file modifications on critical Windows system files, focusing on file creation and write actions. It filters for specific SHA-256 hashes associated with essential system files (<code>ntoskrnl.exe</code>, <code>winload.exe</code>, and <code>winresume.exe</code>) located in the <code>C:\Windows\System32</code> directory. The query identifies changes in these files that could indicate suspicious activity or compromise. Results include the hostname, file path, SHA-256 hash, and event subtype to aid in further investigation.</p>

config case_sensitive = false timeframe = 30d
|dataset = xdr_data
| filter event_type = ENUM.FILE and event_sub_type in (ENUM.FILE_CREATE_NEW, ENUM.FILE_WRITE)
| filter (action_file_sha256 = "8214B4F98D1E18DF604BF2A9ED0CB3C6C4DF062A95181964E3DA5E359CCA4008" and action_file_path = "C:\Windows\System32\ntoskrnl.exe") or
    (action_file_sha256 = "2130B5931E5716DBA361A8B38F13C88397E2B9A59AE0C726681A28C928832187" and action_file_path = "C:\Windows\System32\winload.exe") or
    (action_file_sha256 = "E417504D4C5CB1E01F2C5E5F953E7284491E054AB31D4F492538B09760147CE1" and action_file_path = "C:\Windows\System32\winresume.exe")
| fields agent_hostname, action_file_path, action_file_sha256


// Description: The query is designed to detect attempts to turn off VBS by deleting the EnableVirtualizationBasedSecurity and RequirePlatformSecurityFeatures registry values under HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard
config case_sensitive = false

| dataset = xdr_data 
| filter event_type = ENUM.REGISTRY and event_sub_type = ENUM.REGISTRY_DELETE_VALUE 
| filter action_registry_key_name = "HKEY_LOCAL_MACHINE\SYSTEM\ControlSet\Control\DeviceGuard" and action_registry_value_name in ("EnableVirtualizationBasedSecurity", "RequirePlatformSecurityFeatures") 

| fields agent_hostname, actor_process_image_name, actor_process_command_line, action_registry_key_name, action_registry_value_name, action_registry_data


// Description: The query is designed to detect unsigned processes attempting to turn off VBS by tampering registry values
config case_sensitive = false

| dataset = xdr_data 
| filter event_type = ENUM.REGISTRY and event_sub_type = ENUM.REGISTRY_SET_VALUE 
| filter (action_registry_key_name = "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa" and action_registry_value_name = "LsaCfgFlags") or 
        (action_registry_key_name = "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\CredentialGuard" and action_registry_value_name = "Enabled") or 
        (action_registry_key_name = "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\HypervisorEnforcedCodeIntegrity" and action_registry_value_name = "Enabled") or 
        (action_registry_key_name = "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\SystemGuard" and action_registry_value_name = "Enabled") 
| filter action_registry_data = "0"
| filter actor_process_signature_status = ENUM.UNSIGNED 
| fields agent_hostname, actor_process_image_name, actor_process_command_line, action_registry_key_name, action_registry_value_name, action_registry_data